<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>L√†m b√†i tr·∫Øc nghi·ªám</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Styles ch√≠nh -->
  <link rel="stylesheet" href="style.css" />

  <!-- Fallback style si√™u nh·∫π (ph√≤ng khi thi·∫øu v√†i class trong style.css) -->
  <style>
    /* Start page t·ªëi thi·ªÉu ƒë·ªÉ kh√¥ng v·ª° b·ªë c·ª•c n·∫øu thi·∫øu CSS ngo√†i */
    .start-wrap{min-height:100vh;display:grid;place-items:center;padding:32px 16px;background:#f3f5f7}
    .start-card{width:100%;max-width:560px;background:#fff;border:1px solid #eaf0ff;border-radius:20px;
      box-shadow:0 18px 60px rgba(24,119,242,.12);padding:24px}
    .start-hero{text-align:center;margin-bottom:12px}
    .start-emoji{width:56px;height:56px;line-height:56px;border-radius:50%;background:#e8f1ff;
      border:1px solid #d8e7ff;margin:0 auto 8px;font-size:26px}
    .start-title{font-size:30px;font-weight:900;margin:4px 0 6px}
    .start-sub{color:#64748b;margin:0 0 2px;font-size:14px}
    .field{margin:12px 0 14px}
    .field>label{display:block;font-weight:800;color:#0f172a;margin-bottom:6px}
    .start-card input[type="text"]{width:100%;height:48px;border-radius:12px;border:1px solid #e5e7eb;
      font-size:16px;padding:0 12px}
    .file-dropzone{display:block;width:100%;margin-top:6px;border:2px dashed #dbeafe;background:#fbfdff;
      border-radius:14px;padding:14px;text-align:center;position:relative;cursor:pointer}
    .file-dropzone input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer}
    .btn-lg{width:100%;height:50px;margin-top:12px;background:#1877f2;color:#fff;border:none;border-radius:12px;
      font-size:18px;font-weight:600}
    /* Loader t·ªëi thi·ªÉu */
    .loading-overlay{position:fixed;inset:0;z-index:99999;display:none;align-items:center;justify-content:center;
      background:rgba(15,23,42,.35);backdrop-filter:blur(2px)}
    .loading-overlay.show{display:flex}
    .loading-card{min-width:260px;background:#fff;border:1px solid #eaf0ff;border-radius:16px;padding:16px 18px;
      text-align:center;box-shadow:0 18px 60px rgba(24,119,242,.18)}
    .spinner{width:28px;height:28px;margin:0 auto 10px;border-radius:50%;border:3px solid #dbeafe;
      border-top-color:#1877f2;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .result-wrap{display:flex;justify-content:center;padding:24px 12px}
    .result-card{width:100%;max-width:980px;background:#fff;border:1px solid #eaf0ff;border-radius:18px;padding:22px}
    .result-head{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .result-title{font-size:28px;font-weight:800;margin:0}
    .result-badge{margin-left:auto;background:#e8f1ff;color:#1877f2;border:1px solid #d8e7ff;
      padding:6px 12px;border-radius:999px;font-weight:800;font-size:13px}
    .result-main{display:grid;grid-template-columns:160px 1fr;gap:20px;align-items:center}
    @media(max-width:720px){.result-main{grid-template-columns:1fr}}
    .score-ring{width:140px;height:140px;position:relative}
    .score-ring svg{transform:rotate(-90deg)}
    .score-ring .num{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:26px;font-weight:800}
    .r-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:520px){.r-stats{grid-template-columns:1fr}}
    .r-stat{background:#fff;border:1px solid #eef2ff;border-radius:12px;padding:10px 12px;text-align:center}
    .r-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn-outline{background:#fff;color:#1877f2;border:1px solid #cfe1ff;padding:8px 12px;border-radius:8px}
    .btn-ghost{background:#fff;border:1px dashed #d7def0;padding:8px 12px;border-radius:8px}
    .confetti{position:fixed;inset:0;pointer-events:none;z-index:9999}
    .confetti i{position:absolute;top:-10px;width:8px;height:14px;border-radius:2px;opacity:.9;animation:confetti-fall 1.8s linear forwards}
    @keyframes confetti-fall{to{transform:translateY(110vh) rotate(360deg);opacity:.8}}
    /* Review wrap */
    #reviewContainer *{overflow-wrap:anywhere;word-break:break-word}
  
.polar-table{width:100%;border-collapse:collapse;table-layout:fixed;margin:8px 0}
.polar-table col.yes,
.polar-table col.no{ width:140px; }
.polar-table col.yes,.polar-table col.no{width:120px}
.polar-table { border-collapse: collapse; }
.polar-table th, .polar-table td { border-bottom: none; }   /* b·ªè ƒë∆∞·ªùng ·ªü t·ª´ng √¥ */
.polar-table tbody tr { border-bottom: 1px solid #e5e7eb; } /* ‚Üê 1 ƒë∆∞·ªùng/h√†ng */
.polar-table thead th:nth-child(2),
.polar-table thead th:nth-child(3){ text-align:center; }
.polar-table thead th{background:#1e66f5;color:#fff;text-align:left}
.polar-statement{display:flex;gap:12px;align-items:center}
.polar-statement img{max-width:160px;max-height:120px;border-radius:8px}
.polar-choice{text-align:center}
.polar-table tbody tr{ height:56px; } 
.polar-table td:nth-child(2),.polar-table td:nth-child(3){text-align:center;vertical-align:middle;}
.polar-table input[type="radio"]{width:18px;height:18px;vertical-align:middle}

.polar-table input[type="radio"]{ transform: translateY(1px); } /* 0 / 1 / 2px tu·ª≥ m·∫Øt */


  
/* --- POLAR tiny alignment tweaks --- */
.polar-table tbody td{ vertical-align: middle; height: 56px; vertical-align: center; }
.polar-table tbody td:first-child .polar-statement{ min-height:58px; line-height:1.35; }
.polar-table tbody td:nth-child(2), .polar-table tbody td:nth-child(3){ text-align:center; }
.polar-table input[type="radio"]{ transform: translateY(-5px); }

  </style>
</head>

<body>

  <!-- ========= START PAGE ========= -->
  <div id="startPage" class="start-wrap">
    <div class="start-card">
      <div class="start-hero">
        <div class="start-emoji">üéì</div>
        <h1 class="start-title">B·∫Øt ƒë·∫ßu l√†m b√†i</h1>
        <p class="start-sub">ƒêi·ªÅn t√™n v√† n·∫°p b·ªô ƒë·ªÅ (.json) ‚Äî ch√∫c b·∫°n thi th·∫≠t ‚Äúb·ªëc l·ª≠a ph√π ph√π‚Äù ‚ú®</p>
      </div>

      <div class="field">
        <label for="studentName">H·ªç v√† t√™n</label>
        <input id="studentName" type="text" placeholder="Nh·∫≠p h·ªç v√† t√™n ƒëi n√® ‚úçÔ∏è" />
      </div>

      <div class="field">
        <label for="examFile">Ch·ªçn b·ªô ƒë·ªÅ (.json)</label>
        <label class="file-dropzone" id="dropZone">
          <input id="examFile" type="file" accept=".json" />
          <span class="dz-icon">üìÑ</span>
          <span id="fileName">K√©o th·∫£ b·ªô ƒë·ªÅ v√†o ƒë√¢y ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn</span>
          <span class="dz-sub">H·ªó tr·ª£ t·ªáp .json (‚â§ 5MB)</span>
        </label>
      </div>

      <button id="btnStart" class="btn-lg">B·∫Øt ƒë·∫ßu üöÄ</button>
    </div>
  </div>

  <!-- ========= QUIZ PAGE ========= -->
  <div id="quizPage" class="quiz-container hidden">
    <aside class="quiz-sidebar">
      <h3 id="examSubject">‚Äî</h3>
      <p>Th·ªùi gian: <span id="timeLabel">‚Äî</span></p>
      <div id="questionNav"></div>
      <button id="btnSubmit">N·ªôp b√†i</button>
    </aside>

    <main class="quiz-main">
      <div id="quizMain"></div>
      <div class="question-pager">
        <button id="btnPrev" class="btn-ghost">‚Üê C√¢u tr∆∞·ªõc</button>
        <div id="qIndicator">C√¢u 1/1</div>
        <button id="btnNext">C√¢u ti·∫øp theo ‚Üí</button>
      </div>
      <div id="stickySubmit" class="fab-submit" aria-hidden="true">
  <button id="btnStickySubmit" type="button" title="N·ªôp b√†i nhanh">N·ªôp b√†i üíå</button>
</div>
    </main>
  </div>

  <!-- ========= RESULT PAGE ========= -->
  <div id="resultPage" style="display:none;">
    <div class="confetti" id="confetti"></div>
    <div class="result-wrap">
      <div class="result-card">
        <div class="result-head">
          <h2 class="result-title">K·∫øt qu·∫£</h2>
          <span class="result-badge" id="rSubject">‚Äî</span>
        </div>

        <div class="result-main">
          <div class="score-ring">
            <svg width="140" height="140" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="52" fill="none" stroke="#eef2ff" stroke-width="12"/>
              <circle id="rCircle" cx="60" cy="60" r="52" fill="none"
                      stroke="#1877f2" stroke-linecap="round" stroke-width="12"
                      stroke-dasharray="327" stroke-dashoffset="327"/>
            </svg>
            <div class="num" id="rNum">0</div>
            <div class="lbl">ƒëi·ªÉm</div>
          </div>

          <div>
            <div class="r-remark" id="rRemark">‚Äî</div>
            <div class="r-stats">
              <div class="r-stat"><div class="k">T√™n</div><div class="v" id="rName">‚Äî</div></div>
              <div class="r-stat"><div class="k">T·ªïng ƒëi·ªÉm t·ªëi ƒëa</div><div class="v" id="rMax">‚Äî</div></div>
              <div class="r-stat"><div class="k">Th·ªùi gian</div><div class="v" id="rTime">‚Äî</div></div>
            </div>

            <div class="r-actions">
              <button class="btn-outline" id="btnReview">Xem l·∫°i b√†i l√†m</button>
              <button class="btn-ghost" onclick="location.reload()">L√†m l·∫°i</button>
            </div>
            <div id="reviewContainer" style="margin-top:16px;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========= LOADING OVERLAY ========= -->
  <div id="loader" class="loading-overlay" aria-live="polite" aria-busy="true">
    <div class="loading-card">
      <div class="spinner" role="status" aria-label="ƒêang x·ª≠ l√Ω"></div>
      <div id="loaderText" class="loading-text">ƒêang x·ª≠ l√Ω‚Ä¶</div>
      <div class="loading-sub">Vui l√≤ng ch·ªù trong gi√¢y l√°t</div>
    </div>
  </div>

  <!-- ===== Firebase (compat) ===== -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    /* ============================================================
       CONFIG ‚Äî D√ÅN CONFIG FIREBASE T·∫†I ƒê√ÇY
       ============================================================ */
    const USE_FIRESTORE = true;      // g·ª≠i k·∫øt qu·∫£ l√™n Firestore
    const USE_REALTIME  = false;     // (tu·ª≥ ch·ªçn) Realtime Database

const firebaseConfig = {
  apiKey: "AIzaSyBaMgr9rD_Q81KGHEC3gwfe5er8OULRBsk",
  authDomain: "thdd-9909a.firebaseapp.com",
  projectId: "thdd-9909a",
  storageBucket: "thdd-9909a.firebasestorage.app",
  messagingSenderId: "213987106458",
  appId: "1:213987106458:web:bfda155be607a856550923",
  measurementId: "G-677KE10HT7"
};

    /* ============================================================
       INIT
       ============================================================ */
    let app=null, db=null, rtdb=null;
    function initFirebase(){
      if(app) return;
      if(!firebaseConfig || !firebaseConfig.projectId) return; // ch∆∞a c·∫•u h√¨nh th√¨ b·ªè qua
      app = firebase.initializeApp(firebaseConfig);
      if (USE_FIRESTORE) db = firebase.firestore();
      if (USE_REALTIME)  rtdb = firebase.database();
    }

    const $ = (id)=>document.getElementById(id);

    let examData = null;
    let answers  = {};
    let cur = 0;
    let timerId = null;
    let startTime = 0, durationSec = 0;

    /* ===== Loader helpers ===== */
    function showLoader(msg='ƒêang x·ª≠ l√Ω‚Ä¶'){
      const t=$('loaderText'); if(t) t.textContent=msg;
      $('loader').classList.add('show'); document.body.classList.add('busy');
    }
    function hideLoader(){ $('loader').classList.remove('show'); document.body.classList.remove('busy'); }

    /* ===== ƒê·ªçc th·ªùi l∆∞·ª£ng t·ª´ nhi·ªÅu key kh√°c nhau ===== */
    function readDurationMin(data){
      const c = data || {};
      const d = c.durationMin ?? c.duration ?? c.timeLimit ?? c.time ??
                (c.config && (c.config.durationMin ?? c.config.duration ?? c.config.timeLimit)) ?? 0;
      const n = parseFloat(d);
      return isNaN(n) ? 0 : n;
    }

    /* ===== START ===== */
    $('btnStart').onclick = async () => {
      const name = $('studentName').value.trim();
      const file = $('examFile').files[0];
      if (!name){ alert('Nh·∫≠p t√™n tr∆∞·ªõc nh√©!'); return; }
      if (!file){ alert('Ch·ªçn file JSON b·ªô ƒë·ªÅ!'); return; }

      showLoader('ƒêang t·∫£i b·ªô ƒë·ªÅ‚Ä¶');

      try {
        const text = await file.text();
        try { examData = JSON.parse(text); }
        catch(e){ alert('JSON l·ªói c√∫ ph√°p!'); return; }

        $('startPage').classList.add('hidden');
        $('quizPage').classList.remove('hidden');

        $('examSubject').textContent = examData.subject || 'B√†i ki·ªÉm tra';
        $('questionNav').innerHTML = '';
        answers = {}; cur = 0;

        durationSec = Math.max(0, Math.floor(readDurationMin(examData)*60));
        startTime = Date.now();
        if (durationSec>0) runTimer(); else $('timeLabel').textContent='‚Äî';

        examData.questions.forEach((_,i)=>{
          const b=document.createElement('button'); b.id='navBtn'+i; b.textContent=i+1;
          b.onclick=()=>goTo(i); $('questionNav').appendChild(b);
        });

        renderQuestion(cur);
        updateIndicator();
        $('btnPrev').onclick=prevQ;
        $('btnNext').onclick=nextQ;
        $('btnSubmit').onclick=submitExam;
        $('btnStickySubmit').onclick = submitExam; 
              // Khi b·∫Øt ƒë·∫ßu l√†m b√†i => hi·ªán n√∫t n·ªïi
$('stickySubmit').classList.add('show');
      } finally {
        hideLoader();
      }

    };

    /* ===== Dropzone sugar ===== */
    (function initPrettyDropzone(){
      const dz=$('dropZone'), fi=$('examFile'), nameEl=$('fileName');
      if(!dz||!fi||!nameEl) return;
      const setName=(f)=>{ nameEl.textContent=f?f.name:'K√©o th·∫£ b·ªô ƒë·ªÅ v√†o ƒë√¢y ho·∫∑c b·∫•m ƒë·ªÉ ch·ªçn'; };
      fi.addEventListener('change',()=>setName(fi.files[0]));
      ['dragenter','dragover'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.add('dragover');}));
      ['dragleave','drop'].forEach(ev=>dz.addEventListener(ev,e=>{e.preventDefault();dz.classList.remove('dragover');}));
      dz.addEventListener('drop',e=>{const fs=e.dataTransfer.files;if(fs&&fs.length){fi.files=fs;setName(fs[0]);}});
    })();

    /* ===== TIMER ===== */
    function runTimer(){
      const render=()=>{
        const left = durationSec - Math.floor((Date.now()-startTime)/1000);
        if(left<=0){ $('timeLabel').textContent='00:00'; clearInterval(timerId); submitExam(); return; }
        const m=String(Math.floor(left/60)).padStart(2,'0'); const s=String(left%60).padStart(2,'0');
        $('timeLabel').textContent=`${m}:${s}`;
      };
      render(); timerId=setInterval(render,1000);
    }

    function updateIndicator(){
      $('qIndicator').textContent=`C√¢u ${cur+1}/${examData.questions.length}`;
      [...document.querySelectorAll('#questionNav button')].forEach((b,idx)=>b.style.outline=(idx===cur)?'3px solid rgba(255,255,255,.9)':'none');
    }
    function goTo(i){ if(i>=0 && i<examData.questions.length){ cur=i; renderQuestion(cur); updateIndicator(); } }
    function prevQ(){ goTo(cur-1); }
    function nextQ(){ goTo(cur+1); }

    /* ===== RENDER ===== */
    function renderQuestion(index){
      const q = examData.questions[index];
      const box = $('quizMain'); box.innerHTML='';

      if(q.type==='match'){ renderMatchQuestion(index); return; }
      if(q.type==='single' || q.type==='multi'){ renderChoiceQuestion(index, q.type==='multi'); return; }
      if(q.type==='polar'){ renderPolarQuestion(index); return; }

      const div=document.createElement('div');
      div.className='question';
      div.innerHTML=`<div class="q-line q-text"><strong>C√¢u ${index+1}:</strong> ${q.text||''}</div>
                     <div class="small-muted">[Toi b·ªã g√†, t√¥i ch∆∞a l√†m ƒë∆∞·ª£c lo·∫°i c√¢u h·ªèi n√†y, ƒë·ª£i v√†i h√¥m xem sao]</div>`;
      box.appendChild(div);
    }

    
    /* -- POLAR (Yes/No etc.) -- */
    function renderPolarQuestion(index){
      const q=examData.questions[index]; const box=$('quizMain'); box.innerHTML='';
      const wrap=document.createElement('div'); wrap.className='question';
      const head=document.createElement('div'); head.className='q-line q-text';
      head.innerHTML=`<strong>C√¢u ${index+1}:</strong> ${q.text||''}`; wrap.appendChild(head);
      if(q.image){ const qimg=document.createElement('div'); qimg.className='q-qimg';
                   qimg.innerHTML=`<img src="${q.image}" alt="question-image">`; wrap.appendChild(qimg); }
      const labels = q.variant==='tf' ? ['ƒê√∫ng','Sai'] : (q.variant==='agree' ? ['ƒê·ªìng √Ω','Kh√¥ng ƒë·ªìng √Ω'] : ['C√≥','Kh√¥ng']);
      const table=document.createElement('table'); table.className='polar-table';
      table.innerHTML = `<colgroup><col class="stmt"><col class="yes"><col class="no"></colgroup><thead><tr><th>Statements</th><th>${labels[0]}</th><th>${labels[1]}</th></tr></thead><tbody></tbody>`;
      const tbody = table.querySelector('tbody');
      const arr = Array.isArray(answers[index]) ? answers[index].slice() : [];
      (q.rows||[]).forEach((r,i)=>{
        const tr=document.createElement('tr');
        const tdS=document.createElement('td'); tdS.className='polar-statement';
        const tx=document.createElement('div'); tx.textContent=r.text||''; tdS.appendChild(tx);
        if(r.image){ const im=document.createElement('img'); im.src=r.image; tdS.appendChild(im); }
        const tdA=document.createElement('td'); tdA.className='polar-choice';
        const tdB=document.createElement('td'); tdB.className='polar-choice';
        const name=`pol_${index}_${i}`;
        tdA.innerHTML=`<label><input type="radio" name="${name}" value="0" ${arr[i]===0?'checked':''}></label>`;
        tdB.innerHTML=`<label><input type="radio" name="${name}" value="1" ${arr[i]===1?'checked':''}></label>`;
        tr.appendChild(tdS); tr.appendChild(tdA); tr.appendChild(tdB); tbody.appendChild(tr);
      });
      wrap.appendChild(table); box.appendChild(wrap);

      table.addEventListener('change', (e)=>{
        if(e.target && e.target.name && e.target.name.startsWith('pol_')){
          const m = e.target.name.split('_'); const qi=Number(m[1]); const ri=Number(m[2]);
          if(!Array.isArray(answers[qi])) answers[qi]=[];
          answers[qi][ri]=Number(e.target.value);
        }
      });
    }

    /* -- SINGLE/MULTI -- */
    function renderChoiceQuestion(index, isMulti){
      const q=examData.questions[index]; const box=$('quizMain'); box.innerHTML='';

      const wrap=document.createElement('div'); wrap.className='question';
      const head=document.createElement('div'); head.className='q-line q-text';
      head.innerHTML=`<strong>C√¢u ${index+1}:</strong> ${q.text||''}`; wrap.appendChild(head);

      if(q.img){ const qimg=document.createElement('div'); qimg.className='q-qimg';
                 qimg.innerHTML=`<img src="${q.img}" alt="question-image">`; wrap.appendChild(qimg); }

      const selected = answers[index] ?? (isMulti?[]:null);

      q.options.forEach((opt,i)=>{
        const item=document.createElement('div'); item.className='q-opt'; item.dataset.index=i;
        const picked=isMulti ? (selected.includes(i)) : (selected===i);
        if(picked) item.classList.add('selected');

        item.innerHTML=`
          <div class="opt-label" style="display:flex;gap:10px;align-items:center;justify-content:space-between">
            <div style="flex:1">${opt.text||''}</div>
            ${opt.img?`<img src="${opt.img}" style="max-width:160px;border-radius:8px;border:1px solid #eee">`:''}
          </div>`;

        item.onclick=()=>{
          if(isMulti){
            let arr=Array.isArray(answers[index])?answers[index].slice():[];
            if(arr.includes(i)) arr=arr.filter(x=>x!==i); else arr.push(i);
            answers[index]=arr;
          }else{
            answers[index]=i;
          }
          renderChoiceQuestion(index,isMulti);
          markAnswered(index);
        };

        wrap.appendChild(item);
      });

      box.appendChild(wrap);
    }

    /* -- MATCH (drag-drop) -- */
    function renderMatchQuestion(index){
      const q=examData.questions[index];
      const quizMain=$('quizMain'); quizMain.innerHTML='';

      const wrap=document.createElement('div'); wrap.className='question';
      const qText=document.createElement('div'); qText.className='q-line q-text';
      qText.innerHTML=`<strong>C√¢u ${index+1}:</strong> ${q.text||''}`; wrap.appendChild(qText);

      const board=document.createElement('div'); board.className='drag-board';

      // left (pool)
      const left=document.createElement('div'); left.className='drag-left';
      left.innerHTML=`<div class="drag-title">L·ª±a ch·ªçn</div>
                      <div class="drag-pool" id="pool-${index}"></div>
                      <div class="drag-tip">K√©o n·ªôi dung l·ª±a ch·ªçn v√† th·∫£ v√†o m·ª•c t∆∞∆°ng ·ª©ng ‚Üí</div>`;
      const pool=left.querySelector('.drag-pool');

      pool.addEventListener('dragover',e=>{e.preventDefault();pool.classList.add('over');});
      pool.addEventListener('dragleave',()=>pool.classList.remove('over'));
      pool.addEventListener('drop',e=>{
        e.preventDefault(); pool.classList.remove('over');
        const leftId=parseInt(e.dataTransfer.getData('text/lid'),10);
        if(Number.isNaN(leftId)) return;
        const chipInSlot=document.querySelector(`.drop-slot .drag-chip[data-lid="${leftId}"]`);
        if(chipInSlot){
          const slotEl=chipInSlot.closest('.drop-slot');
          if(slotEl){ const r=slotEl.dataset.right; delete (answers[index]||{})[r]; }
          pool.appendChild(chipInSlot);
          markAnswered(index);
        }
      });

      // chips
      const chips=q.pairs.map((p,i)=>({id:i,text:p.left})).sort(()=>Math.random()-0.5);
      chips.forEach(c=>{
        const chip=document.createElement('div'); chip.className='drag-chip';
        chip.textContent=c.text; chip.title=c.text; chip.draggable=true; chip.dataset.lid=c.id;
        chip.addEventListener('dragstart',e=>{chip.classList.add('dragging');e.dataTransfer.setData('text/lid',String(c.id));});
        chip.addEventListener('dragend',()=>chip.classList.remove('dragging'));
        chip.addEventListener('dblclick',()=>{
          const slotEl=chip.closest('.drop-slot'); if(slotEl){const r=slotEl.dataset.right; delete (answers[index]||{})[r]; pool.appendChild(chip); markAnswered(index);}
        });
        pool.appendChild(chip);
      });

      // right targets
      const right=document.createElement('div'); right.className='drag-right';
      right.innerHTML=`<div class="drag-title">C√¢u tr·∫£ l·ªùi</div><div class="targets"></div>`;
      const targets=right.querySelector('.targets');

      if(!answers[index]) answers[index]={}; // rightIdx -> leftId

      q.pairs.forEach((p,rightIdx)=>{
        const line=document.createElement('div'); line.className='target-line';
        line.innerHTML=`<div class="drop-slot" data-right="${rightIdx}"></div>
                        <div class="target-text">${p.right}</div>`;
        const slot=line.querySelector('.drop-slot');

        slot.addEventListener('dragover',e=>{e.preventDefault();slot.classList.add('over');});
        slot.addEventListener('dragleave',()=>slot.classList.remove('over'));
        slot.addEventListener('drop',e=>{
          e.preventDefault(); slot.classList.remove('over');
          const leftId=parseInt(e.dataTransfer.getData('text/lid'),10);
          if(Number.isNaN(leftId)) return;
          assignToRightSlot(index,rightIdx,leftId,pool,slot);
        });

        targets.appendChild(line);
      });

      board.appendChild(left); board.appendChild(right);
      wrap.appendChild(board); quizMain.appendChild(wrap);

      // restore
      Object.entries(answers[index]).forEach(([rightIdx,leftId])=>{
        const slot=quizMain.querySelector(`.drop-slot[data-right="${rightIdx}"]`);
        const chip=quizMain.querySelector(`.drag-chip[data-lid="${leftId}"]`);
        if(slot && chip) slot.replaceChildren(chip);
      });

      updateIndicator();
    }

    function assignToRightSlot(qIndex,rightIdx,leftId,pool,slot){
      Object.entries(answers[qIndex]||{}).forEach(([r,l])=>{
        if(Number(l)===Number(leftId) && Number(r)!==Number(rightIdx)){
          const chip=document.querySelector(`.drag-chip[data-lid="${l}"]`);
          if(chip) pool.appendChild(chip);
          delete answers[qIndex][r];
          const oldSlot=document.querySelector(`.drop-slot[data-right="${r}"]`);
          if(oldSlot) oldSlot.textContent='';
        }
      });

      const curLeft=answers[qIndex][rightIdx];
      if(curLeft!==undefined){
        const curChip=document.querySelector(`.drag-chip[data-lid="${curLeft}"]`);
        if(curChip) pool.appendChild(curChip);
      }

      const chip=document.querySelector(`.drag-chip[data-lid="${leftId}"]`);
      if(chip) slot.replaceChildren(chip);

      answers[qIndex][rightIdx]=leftId;
      markAnswered(qIndex);
    }

    function markAnswered(qIndex){
      const btn=$('navBtn'+qIndex); if(!btn) return;
      const q=examData.questions[qIndex]; let filled=false;
      if(q.type==='match'){ filled=Object.keys(answers[qIndex]||{}).length>0; }
      else if(q.type==='multi'){ filled=(answers[qIndex]||[]).length>0; }
      else{ filled=Number.isInteger(answers[qIndex]); }
      btn.classList.toggle('answered-btn',filled);
    }

    /* ===== SUBMIT ===== */
    async function submitExam(){
      showLoader('ƒêang n·ªôp b√†i, ch·ªù x√≠u nha‚Ä¶');
      try{
        clearInterval(timerId);

        let score=0;
        examData.questions.forEach((q,idx)=>{
          if(q.type==='match'){
            const map=answers[idx]||{};
            q.pairs.forEach((p,i)=>{ if(Number(map[i])===i) score+=(p.score||0); });
          }else if(q.type==='multi'){
            const picked=new Set(answers[idx]||[]);
            const correctIdx=q.options.map((o,i)=>o.correct?i:null).filter(i=>i!==null);
            const allCorrect=correctIdx.every(i=>picked.has(i)) && picked.size===correctIdx.length;
            if(allCorrect){ q.options.forEach(o=>{ if(o.correct) score+=(o.score||0); }); }
          }else if(q.type==='polar'){
            const arr = Array.isArray(answers[idx]) ? answers[idx] : [];
            (q.rows||[]).forEach((r,i)=>{ if(arr[i]===r.correctIndex){ score += (r.score||1); } });
          }else if(q.type==='single'){
            const i=answers[idx];
            if(Number.isInteger(i) && q.options[i] && q.options[i].correct){ score+=(q.options[i].score||0); }
          }
        });

        let maxScore=0;
        examData.questions.forEach(q=>{
          if(q.type==='match'){ maxScore+=(q.pairs||[]).reduce((t,p)=>t+(p.score||0),0); }
          else if(q.type==='polar'){ maxScore+=(q.rows||[]).reduce((t,r)=>t+(r.score||0),0) || (q.rows?q.rows.length:0); } else{ maxScore+=(q.options||[]).filter(o=>o.correct).reduce((t,o)=>t+(o.score||0),0); }
        });

        const elapsed=Math.floor((Date.now()-startTime)/1000);

        try{
          initFirebase();
          const payload={
            name:$('studentName').value.trim(),
            subject:examData.subject||'',
            score,maxScore,durationSec:elapsed,
            mode:examData.mode||'',
            createdAt:Date.now()
          };
          if(USE_FIRESTORE && db){
            await db.collection('quizResults').add({...payload,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
          }
          if(USE_REALTIME && rtdb){
            const path=`quizResults/${(examData.subject||'unknown').replace(/\W+/g,'_')}`;
            await rtdb.ref(path).push(payload);
          }
        }catch(e){ console.warn('Kh√¥ng g·ª≠i ƒë∆∞·ª£c k·∫øt qu·∫£:',e); }

        $('quizPage').classList.add('hidden');
        renderResultCard({
          name:$('studentName').value.trim(),
          subject:examData.subject||'‚Äî',
          score,maxScore,elapsed
        });
        $('stickySubmit').classList.remove('show');
      }finally{
        hideLoader();
      }
      
    }

    /* ===== RESULT RENDER ===== */
    function renderResultCard({name,subject,score,maxScore,elapsed}){
      const r=(id)=>$(id);
      $('resultPage').style.display='block';
      r('rName').textContent=name||'‚Äî';
      r('rSubject').textContent=subject||'‚Äî';
      r('rMax').textContent=maxScore;
      r('rTime').textContent=`${Math.floor(elapsed/60)} ph√∫t ${elapsed%60} gi√¢y`;

      const pct=maxScore>0?Math.round((score/maxScore)*100):0;
      r('rRemark').textContent = pct>=90?'Qu√° ƒë·ªânh lu√¥n üíé': pct>=75?'X·ªãn x√≤ ph·∫øt üî•': pct>=50?'·ªîn √°p n√® üëç':'C·ªë th√™m t·∫πo n·ªØa nha üí™';

      const CIRC=2*Math.PI*52; const circle=r('rCircle'); const num=r('rNum');
      let cur=0; const anim=setInterval(()=>{
        cur+=Math.max(1,Math.round((score-cur)/10));
        if(cur>=score){cur=score;clearInterval(anim);}
        num.textContent=cur;
        const dash=maxScore>0?(cur/maxScore)*CIRC:0;
        circle.style.strokeDasharray=CIRC; circle.style.strokeDashoffset=(CIRC-dash);
      },20);

      fireConfetti();
      $('btnReview').onclick=reviewExam;
    }
    function fireConfetti(){
      const colors=['#60a5fa','#34d399','#f472b6','#f59e0b','#c084fc','#f87171'];
      const box=$('confetti'); if(!box) return; box.innerHTML='';
      for(let i=0;i<80;i++){
        const el=document.createElement('i'); el.style.left=Math.random()*100+'vw';
        el.style.background=colors[Math.floor(Math.random()*colors.length)];
        el.style.animationDuration=(1.2+Math.random()*1.2)+'s';
        el.style.transform=`translateY(0) rotate(${Math.random()*360}deg)`;
        box.appendChild(el); setTimeout(()=>el.remove(),1900);
      }
    }

    /* ===== REVIEW ===== */
    function reviewExam(){
  const wrap = $('reviewContainer'); wrap.innerHTML = '';
  (examData.questions||[]).forEach((q, idx)=>{
    const card = document.createElement('div'); card.className='question';
    const t = (q.type||'').toLowerCase();
    card.innerHTML = `<div class="q-line q-text"><strong>C√¢u ${idx+1}:</strong> ${q.text||''}</div>`;

    if(t==='match'){
      const ul=document.createElement('ul'); ul.style.listStyle='none'; ul.style.padding='0'; ul.style.margin='0';
      (q.pairs||[]).forEach((p,i)=>{
        const ok=(Number((answers[idx]||{})[i])===i);
        const li=document.createElement('li');
        li.innerHTML=`${ok?'‚úÖ':'‚ùå'} <strong>${p.left}</strong> ‚Üí ${p.right}`;
        ul.appendChild(li);
      });
      card.appendChild(ul);

    }else if(t==='polar' || Array.isArray(q.rows)){
      const labels = q.variant==='tf' ? ['ƒê√∫ng','Sai'] : (q.variant==='agree' ? ['ƒê·ªìng √Ω','Kh√¥ng ƒë·ªìng √Ω'] : ['C√≥','Kh√¥ng']);
      const table=document.createElement('table'); table.className='polar-table';
      table.innerHTML=`<colgroup><col class="stmt"><col class="yes"><col class="no"></colgroup>
        <thead><tr><th>Statements</th><th>${labels[0]}</th><th>${labels[1]}</th></tr></thead><tbody></tbody>`;
      const tbody=table.querySelector('tbody');
      const arr = Array.isArray(answers[idx]) ? answers[idx] : [];
      (q.rows||[]).forEach((r,i)=>{
        const tr=document.createElement('tr');
        const tdS=document.createElement('td'); tdS.className='polar-statement';
        tdS.textContent=r.text||''; const tdA=document.createElement('td'); const tdB=document.createElement('td');
        const pick=arr[i], ok=(pick===r.correctIndex);
        tdA.style.textAlign=tdB.style.textAlign='center';
        tdA.innerHTML = pick===0 ? '<strong>‚úì</strong>' : '';
        tdB.innerHTML = pick===1 ? '<strong>‚úì</strong>' : '';
        if(pick===0) tdA.style.background = ok ? '#ecfdf5' : '#fee2e2';
        if(pick===1) tdB.style.background = ok ? '#ecfdf5' : '#fee2e2';
        tr.append(tdS,tdA,tdB); tbody.appendChild(tr);
      });
      card.appendChild(table);

    }else if(t==='single' || t==='multi'){
      (q.options||[]).forEach((o,i)=>{
        const picked = t==='multi' ? (answers[idx]||[]).includes(i) : answers[idx]===i;
        const isCorrect = !!o.correct;
        const div=document.createElement('div');
        div.style.cssText='padding:6px 8px;border:1px solid #eef2ff;border-radius:8px;margin-bottom:6px';
        if(isCorrect && picked) div.style.background='#ecfdf5';
        else if(picked && !isCorrect) div.style.background='#fee2e2';
        else if(isCorrect) div.style.background='#f0f9ff';
        div.innerHTML = `${picked ? (isCorrect?'‚úÖ ':'‚ùå ') : (isCorrect?'‚úîÔ∏è ':'')}${o.text||''}`;
        card.appendChild(div);
      });

    }else if(t==='number' || t==='numeric'){
      const ua = answers[idx];
      const ca = q.answer ?? q.correct ?? q.correctAnswer;
      const ok = (ua!=null && String(ua).trim()===String(ca).trim());
      const box=document.createElement('div');
      box.style.cssText='padding:8px 10px;border:1px solid #e5e7eb;border-radius:8px';
      box.style.background = (ua==null||ua==='') ? '#fff' : (ok?'#ecfdf5':'#fee2e2');
      box.innerHTML = `ƒê√°p √°n c·ªßa b·∫°n: <strong>${ua ?? '(b·ªè tr·ªëng)'}</strong>` + (ca!=null?` ¬∑ ƒê√∫ng: <strong>${ca}</strong>`:'');
      card.appendChild(box);

    }else{
      const ua = answers[idx];
      const pre=document.createElement('div');
      pre.style.cssText='padding:6px 8px;border:1px dashed #e5e7eb;border-radius:8px';
      pre.textContent = (ua==null || ua==='') ? '(b·ªè tr·ªëng)' : String(ua);
      card.appendChild(pre);
    }

    $('reviewContainer').appendChild(card);
  });
  $('btnReview') && ($('btnReview').disabled=true);
}

  </script>
  <!-- Floating Submit (cute) -->
<!-- <div id="stickySubmit" class="fab-submit" aria-hidden="true">
  <button id="btnStickySubmit" type="button" title="N·ªôp b√†i nhanh">N·ªôp b√†i üíå</button>
</div> -->

</body>
</html>
